config:
  target: ' '
  phases:
    - duration: 30
      arrivalRate: 5
      name: "Warm-up"
    - duration: 60
      arrivalRate: 5
      rampTo: 50
      name: "Light load ramp"
    - duration: 120
      arrivalRate: 50
      rampTo: 300
      name: "Heavy load ramp"
    - duration: 30
      arrivalRate: 300
      name: "Peak load"
  processor: '{{ $processEnvironment.PROCESSOR_DIR }}/logger.js'

  http:
    timeout: 10

  payload:
    path: 'users.csv'
    fields:
      - 'userName'
      - 'name'
      - 'password'
  variables:
    product:
      - 'QWERTY'
      - 'EASYSTOOL'
      - 'REFLECTXXX'
scenarios:
  # Pure login flow - validates credentials
  - flow:
      - get:
          url: '{{ frontend }}/'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 200
      - function: 'setNeedsRegistration'
      - post:
          url: '{{ frontend }}/register'
          name: 'register'
          ifTrue: 'needsRegistration'
          followRedirect: false
          form:
            userName: '{{ userName }}'
            password: '{{ password }}'
          beforeRequest: 'beforeRegister'
          afterResponse: 'afterRegister'
          expect:
            - statusCode: 302
      - post:
          url: '{{ frontend }}/setUser'
          name: 'login'
          followRedirect: false
          form:
            userName: '{{ userName }}'
            password: '{{ password }}'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 302
    name: 'login only'
    weight: 1

  # Register + Login + Multiple items checkout flow
  # Tests auth validation on each request
  - flow:
      - get:
          url: '{{ frontend }}/'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 200
      - function: 'setNeedsRegistration'
      - post:
          url: '{{ frontend }}/register'
          name: 'register'
          ifTrue: 'needsRegistration'
          followRedirect: false
          form:
            userName: '{{ userName }}'
            password: '{{ password }}'
          beforeRequest: 'beforeRegister'
          afterResponse: 'afterRegister'
          expect:
            - statusCode: 302
      - post:
          url: '{{ frontend }}/setUser'
          name: 'login'
          followRedirect: false
          form:
            userName: '{{ userName }}'
            password: '{{ password }}'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 302
      # Multiple requests after login to measure auth check overhead
      - get:
          url: '{{ frontend }}/'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 200
      - get:
          url: '{{ frontend }}/product/{{product}}'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 200
      - post:
          url: '{{ frontend }}/addCartItem'
          followRedirect: false
          form:
            productId: '{{ product }}'
            quantity: 3
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 302
      - get:
          url: '{{ frontend }}/product/{{product}}'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 200
      - post:
          url: '{{ frontend }}/addCartItem'
          followRedirect: false
          form:
            productId: '{{ product }}'
            quantity: 1
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 302
      - get:
          url: '{{ frontend }}/product/{{product}}'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 200
      - post:
          url: '{{ frontend }}/addCartItem'
          followRedirect: false
          form:
            productId: '{{ product }}'
            quantity: 4
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 302
      - get:
          url: '{{ frontend }}/cart'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 200
      - post:
          url: '{{ frontend }}/checkout'
          followRedirect: false
          form:
            email: 'blubb@blubbmail.com'
            street_address: 'awesome street'
            zip_code: '12362'
            city: 'nope city'
            state: 'NY'
            country: 'Germany GmbH'
            credit_card_number: '4432-8015-6152-0454'
            credit_card_expiration_month: '1'
            credit_card_expiration_year: '2021'
            credit_card_cvv: '123'
          beforeRequest: 'beforeRequest'
          afterResponse: 'afterResponse'
          expect:
            - statusCode: 302
    name: 'auth with multiple requests'
    weight: 3